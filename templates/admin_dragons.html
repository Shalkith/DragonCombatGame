<h2>Dragons</h2>

<table id="dragons-table" style="width:100%; border-collapse:collapse; color:#eee;">
    <thead>
        <tr style="background:#222;">
            <th>Rank</th>
            <th>Name</th>
            <th>Breed</th>
            <th>Age</th>
            <th>Owner</th>
            <th>Stats</th>
            <th>Skills</th>
            <th>Spells</th>
            <th>Abilities</th>
            <th>Favor</th>
            <th>Record</th>
        </tr>
    </thead>
    <tbody>
        {% for d in dragons|sort(attribute='latter_position') %}
        <tr style="border-bottom:1px solid #333;">
            <td>{{ d.latter_position }}</td>
            <td>{{ d.name }}</td>
            <td>{{ d.breed }}</td>
            <td>{{ d.age }}</td>
            <td>{{ d.ownerid }}</td>
            <td>
                ATK: {{ d.attack }}<br>
                DEF: {{ d.defense }}<br>
                BODY: {{ d.body }}<br>
                INT: {{ d.intellect }}<br>
                WILL: {{ d.will }}<br>
                RES: {{ d.resist }}<br>
                SPD: {{ d.speed }}<br>
                DISC: {{ d.discipline }}<br>
                LIFE: {{ d.life }}<br>
                ESS: {{ d.essence }}
            </td>
            <td>
                {% for skill, val in d.skills.items() %}
                    {{ skill }}: {{ val }}<br>
                {% endfor %}
            </td>
            <td>
                {% for spell, val in d.spells.items() %}
                    {{ spell }}: {{ val }}<br>
                {% endfor %}
            </td>
            <td>
                {% for ability, val in d.abilities.items() %}
                    {{ ability }}: {{ val }}<br>
                {% endfor %}
            </td>
            <td>
                <div style="background:#333; border-radius:10px; width:100px; overflow:hidden; height:12px;">
                    <div style="background:#ff4747; width:{{ d.favor }}%; height:100%;"></div>
                </div>
                {{ d.favor }}%
            </td>
            <td>
                Wins: {{ d.wins }}<br>
                Losses: {{ d.losses }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
async function generateDragons() {
    const qty = document.getElementById('quantity').value || 1;
    const resultSpan = document.getElementById('gen-result');
    resultSpan.innerText = 'Generating...';
    try {
        const res = await fetch(`/makenpcdragon/${qty}`);
        const data = await res.json();
        if (data.error) {
            resultSpan.innerText = data.error;
        } else {
            resultSpan.innerText = `Generated ${data.dragons.length} dragons!`;
            // Reload the dragons table by re-fetching the section
            const sectionRes = await fetch('/admin/dragons');
            const html = await sectionRes.text();
            document.getElementById('content').innerHTML = html;
        }
    } catch (err) {
        resultSpan.innerText = 'Error generating dragons: ' + err;
    }
}
</script>
